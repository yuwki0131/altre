# alisp 設定モジュール化ドキュメント

## 1. 概要
alisp を用いて設定情報を外部ファイル化し、altre 起動時に自動読み込みする仕組みを整備する。  
MVP ではキーバインド設定を対象とし、従来ハードコードされていたバインド定義を alisp スクリプトへ移管する。

## 2. 読み込みフロー
- デフォルト設定: `<プロジェクトルート>/alisp/init.al`
- ユーザー設定: `~/.altre/init.al`
- 起動手順:  
  1. デフォルト init を評価  
  2. ユーザー init が存在すれば続けて評価  
  3. 評価完了後に画面初期化
- スクリプト拡張子: `.al`

## 3. モジュール仕様
- `load` 特殊フォームでファイル読み込みを行う。
  - 相対パス: 現在ロード中ファイルのディレクトリ基準 (例: `(load "./module.al")`)
  - 絶対パス: OS のルートから直接指定 (例: `(load "/path/to/module.al")`)
- 名前空間は未導入。`load` は指定ファイルの内容をグローバル環境へ展開する。
- ファイル読み込み後は即座に `eval` され、副作用が適用される。

## 4. キーバインド外部化ポリシー
- 既存キーバインドはコマンド化し、`M-x` 経由でも呼び出せるよう統一する。
- alisp からは `(bind-key "<キー>" "<コマンド名>")` API でバインドを設定する。
- デフォルトキーバインドは `alisp/init.al` に移植し、Rust 側の静的定義は撤去する。
- 起動後に alisp 経由で定義されたバインドが従来どおり動作することを回帰テストで保証する。

## 5. 将来拡張（MVP対象外）
- モードライン／行番号／配色など表示設定の外部化
- 多言語対応（ローカライズ）
- 拡張モジュール管理（名前空間、依存解決）

## 6. 実装メモ
- `load` は極力簡素な仕組みとし、将来の名前空間導入に備えて呼び出し箇所を限定する。
- ユーザー設定のエラーはアプリケーションを停止させず、ミニバッファ経由で通知する。
- 今回の成果を基盤とし、後続フェーズで他の設定項目を段階的に外部化する。

## 7. テスト
- `tests/alisp_keybinding_tests.rs` で、ユーザー `init.al` が既定バインドを上書きできることを検証。
  - デフォルトの `C-n` が保持されることを確認しつつ、`C-x C-f` を `goto-line` に再バインドして動作を確認。
- 追加で alisp 層のユニットテストを拡張する際は、`Interpreter` へモックホストを注入し `bind-key` の副作用を直接検証する。
