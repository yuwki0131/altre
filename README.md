# altre

<p align="center">
  <img src="logo/altre-logo-readme.png" alt="altre logo" width="200" />
</p>

Rustとratatuiで構築された現代的なEmacs風テキストエディタ

## プロジェクト概要

**altre** は、Emacsのコンセプトを継承しつつ、現代的な技術でゼロから構築された新しいテキストエディタです。カスタムLisp方言（alisp）による拡張性を持つ、高速で信頼性の高いテキスト編集環境の提供を目標としています。

> **開発メモ**: このリポジトリは個人で試作中のプロジェクトです。外部からのサポート提供・Issue・Pull Request などの受付は想定していません。ドキュメントは自分用の進行管理と記録を兼ねています。

### プロジェクトの特徴
- **ドキュメント言語**: すべてのドキュメント、コメント、設計書は日本語で記述
- **ファイル名**: ファイル名は英語名を使用（システム互換性のため）
- **コードコメント**: Rustコード内のコメントも日本語で記述
- **モノレポ構成**: すべての成果物を単一リポジトリで管理

### 主要機能（計画）
- **Emacsコンセプト継承**: バッファ/ポイント/マーク、リージョン、キルリングの操作モデル
- **現代的キーバインド**: Emacs風キーバインドとグローバル/メジャー/マイナー/ローカルの階層構造
- **M-xインターフェース**: ミニバッファでのコマンド実行と補完機能
- **alisp拡張言語**: Scheme系Lisp-1タイプのカスタム言語での機能拡張
- **高性能アーキテクチャ**: Rustでの安全で高速な実装
- **マルチプラットフォーム**: TUI（ratatui）から始まり、将来的にGUI（Tauri）へ発展

## プロジェクト構成

```
.
├── README.md          # プロジェクト概要とドキュメント
├── QA.md             # プロジェクト明確化のための質問と回答
├── TASK_MANAGEMENT.md # タスク管理方法とディレクトリ構成
├── docs/             # 設計ドキュメントとアーキテクチャガイド
├── app/              # アプリケーションコードと成果物
├── test/             # テスト、特にE2Eテストとテストデータ
├── tasks/            # タスク管理（markdown-based）
│   ├── todo/         # TODOタスク（未実装・未着手）
│   │   ├── mvp/      # MVP実装タスク
│   │   ├── alisp/    # alisp実装タスク
│   │   ├── design/   # 設計タスク
│   │   ├── bugs/     # 不具合対応タスク
│   │   └── future/   # 将来的な機能タスク
│   ├── proceeding/   # 進行中タスク
│   └── done/         # 完了済みタスク
├── manuals/          # ユーザー・開発者マニュアル
└── temp/             # 一時的な設計作業・調査メモ
```

## 実行方法
- `cargo run --offline` でTUI版altreを起動（簡易的なMVP UI）
- 文字キーとEnter/Tabでテキストを挿入、Backspace/Deleteで削除
- 矢印キー・Home/End・PageUp/PageDownで移動、`Ctrl+Q`または`Ctrl+C`で終了
- `Ctrl+S`など未実装のショートカットはミニバッファにメッセージを表示

## MVP仕様

### 対象環境
- **主要対象**: NixOS + Wayland + Hyprland
- **MVPインターフェース**: ratatuiを使用したTUI（ターミナルユーザーインターフェース）
- **将来計画**: Tauriによる GUI版の実装

### MVP技術スタック
- **コア言語**: Rust（安全性とパフォーマンスを重視）
- **TUIフレームワーク**: ratatui + crossterm
- **テキストモデル**: ギャップバッファ（シンプル実装）
- **文字エンコーディング**: UTF-8のみ対応
- **改行コード**: LFのみ対応
- **テスト戦略**: プロパティベーステスト（proptest）を中心とした品質保証

### MVP機能セット

#### 必須機能
1. **ファイル操作**
   - ファイルオープン: `C-x C-f`（Tab補完、相対/絶対パス対応）
   - ファイル保存: `C-x C-s`
   - 新規ファイル作成サポート

2. **基本編集**
   - テキスト入力
   - 文字削除: Backspace/Delete
   - 改行（Enter）

3. **ナビゲーション**
   - 矢印キー
   - Emacs風移動: `C-n`/`C-p`（上/下）、`C-f`/`C-b`（前進/後退）

4. **インターフェース**
   - コマンド入力とファイルパス用ミニバッファ
   - ミニバッファでのエラー表示
   - 基本的な色サポート
   - `exit`コマンドまたは`C-x C-c`による終了

#### MVP対象外機能（将来実装）
- alispインタープリターと拡張性
- シンタックスハイライト（Tree-sitter）
- LSP統合
- 高度なファイル処理（複数エンコーディング、CRLF）
- 設定ファイル
- マウスサポート
- 高度な補完と検索

## 開発ロードマップ

### フェーズ1: MVP - コア機能の実装（現在）
**目標**: 実用的なテキストエディタとしての基本機能を完成
- ギャップバッファベースのテキスト管理
- ファイル操作（オープン・保存）と基本編集
- M-xコマンドインターフェースとミニバッファ
- Emacs風キーバインドの実装
- 純粋Rust実装（alisp拡張なし）

### フェーズ2: alispエコシステムの構築
**目標**: ユーザーカスタマイズ可能なエディタへの進化
- alispインタープリターの設計・実装（自作Scheme系）
- 安定した拡張APIの設計（バッファ・ウィンドウ・プロセス操作）
- 設定システム（~/.alisp/ディレクトリの.alispファイル）
- キーバインドカスタマイズとテーマシステム

### フェーズ3: 高度なテキスト編集機能
**目標**: プログラミングエディタとしての完成度向上
- Tree-sitterベースのシンタックスハイライト
- インクリメンタル検索と正規表現置換
- 高度なUndo/Redoシステム（線形・永続化）
- マルチエンコーディング対応（CP932、CRLF等）

### フェーズ4: 開発支援ツール統合
**目標**: IDEライクな機能を持つエディタへ
- LSPクライアント実装（非同期RPC、キャンセル対応）
- フォーマッタ・リンター統合（保存時フック、差分適用）
- Git/VCS連携（diff表示、blame、コミットインターフェース）
- デバッガー統合（DAPサポート）

### フェーズ5: GUI版とパフォーマンス最適化
**目標**: 大規模プロジェクトでも快適に使用可能なエディタへ
- Tauriベースの GUI版実装
- パフォーマンス最適化（巨大ファイル、超長行対応）
- 高度なレンダリング（HarfBuzz文字整形、絵文字サポート）
- アクセシビリティ対応（スクリーンリーダー等）

### プロジェクト管理方針
- **タスク管理**: `tasks/`ディレクトリ内のMarkdownファイルで管理（詳細は`TASK_MANAGEMENT.md`参照）
  - 1タスク1Markdownファイル形式
  - カテゴリ別ディレクトリ構成（MVP、alisp、設計、将来機能）
  - 進行状況によるディレクトリ分類（todo/proceeding/done）
- **イシュー管理**: GitHub Issues/PRを使用せず、全てローカルファイルで管理
- **開発体制**: 個人開発プロジェクト
- **バージョン管理**: Gitでの手動ブランチ/コミット管理

## コアアーキテクチャ

### 編集モデルの基本設計
* **バッファモデル**: バッファ/ポイント/マーク、リージョン、キルリング、レジスタ、マーカーの語彙と不変条件
* **テキスト格納方式**: ギャップバッファ (MVP) → ロープ/ピーステーブル/COW+mmap（巨大ファイル対応）
* **アンドゥ体系**: 線形アンドゥ → 永続化アンドゥ（ファイル別ヒストリ保存）

### 機能系アーキテクチャ
* **検索・置換システム**: インクリメンタル検索、正規表現エンジン、Unicode対応、検索ヒストリ
* **非同期アーキテクチャ**: GUI/TUI共通イベントループ、非同期I/O、キャンセル可能ジョブシステム
* **サブプロセス統合**: 非同期プロセス管理、パイプライン処理
* **ファイルシステム連携**: inotify/kqueue/FSEvents/ReadDirectoryChangesW、リロード/競合解決UI
* **信頼性機能**: オートセーブ、バックアップ、クラッシュリカバリ（ジャーナル/スナップショット）

### 表示・レンダリングシステム
* **プラットフォーム戦略**: TUI (ratatui) → 将来的にGUI (Tauri)
* **テキストレンダリング**: 基本文字表示 (MVP) → HarfBuzz文字整形、Unicode正規化、双方向テキスト、合字・絵文字サポート
* **フォントシステム**: 等幅フォント保証、CJK文字幅対応、絵文字フォント統合
* **入力メソッド連携**: fcitx5優先、ibus/TSF/macOS IME対応、候補ウィンドウ管理
* **パフォーマンス最適化**: インクリメンタル描画、行キャッシュ、遅延レイアウト、超長行仮想化

### 入力システムとキーバインド
* **キーマップ階層設計**: グローバル/メジャー/マイナー/ローカルの優先順位とシャドーイング規則
* **コンビネーションキー**: 連続キーシーケンス（C-x C-f等）の完全サポート
* **クロスプラットフォーム対応**: OS/IME衝突回避、Waylandグラブ、端末キーコード差吸収
* **ポインティングデバイス**: MVP非対応 → 将来的にマウス/タッチパッドサポート

### 拡張性アーキテクチャ
* **alisp言語システム**: 自作Scheme系Lisp-1言語（MVP後実装、EmacsのElisp相当の役割）
* **公開API設計**: バッファ・ウィンドウ・プロセス・表示・ミニバッファ操作の安定インターフェース
* **フックシステム**: before/after/aroundアドバイス、メジャー/マイナーモードライフサイクル
* **パッケージエコシステム**: レジストリシステム、デジタル署名検証、依存解決、セマンティックバージョニング

### 言語支援システム（将来実装）
* **シンタックス解析**: Tree-sitterベースのインクリメンタル解析、シンタックスハイライト、構文ノードAPI
* **LSPシステム**: 非同期RPC、キャンセル対応、並列ドキュメント処理（大規模プロジェクト対応）
* **コード整形システム**: 保存時自動フォーマット、差分適用、部分範囲フォーマット
* **デバッグ支援**: DAPプロトコル対応、ステップ実行、ブレークポイント管理、テストランナー統合

### ユーザーインターフェース設計原則
* **ミニバッファシステム**: ファジー/前方一致補完、アクション選択、多段プロンプト対応
* **ウィンドウ管理**: 柔軟な分割・配置モデル、レイアウト保存、タブ/ワークスペース管理
* **ステータス表示**: 軽量で拡張可能なモードライン、遅延評価、パフォーマンス配慮
* **コマンド発見性**: M-x一元管理、最近使用コマンド記録、キーワード検索対応
* **キーバインド哲学**: Emacs互換性とモダン操作性のバランス、学習コスト最小化

### 国際化とファイル互換性
* **文字エンコーディング**: UTF-8専用 (MVP) → 多様なエンコーディング検出/保存（BOM、CP932等）
* **改行コード対応**: LF専用 (MVP) → CRLF/CRマルチ対応
* **コーディング規約**: EditorConfig互換、行末空白/タブ幅/インデントポリシー管理
* **大容量データ処理**: 超長行対応（ログファイル、JSON minify等）、遅延ローディング
* **クリップボード連携**: プラットフォーム固有の違いを吸収（X11 PRIMARY/CLIPBOARD、Wayland、Windows、macOS）

### 外部ツール統合（将来実装）
* **バージョン管理システム**: Gitコア連携（diff表示、blame、ステージング、コミットインターフェース）
* **検索システム**: ripgrep統合、プロジェクト全体検索、ファイルタイプフィルタ
* **リモートアクセス**: TRAMP風機能（SSH/SFTP/SSHFS、プロセスプロキシ）、レイテンシ隠蔽
* **統合ターミナル**: 必要性検討、端末互換性（xterm系）、スクロールバック検索

### セキュリティとプライバシー
* **拡張セキュリティ**: 権限分離システム、デジタル署名検証、サンドボックス実行環境
* **プライバシー保護**: テレメトリ完全オプトイン、データ最小化、匿名化処理
* **オフライン動作**: ネットワーク不要での完全機能、オフラインでの再現性保証

### 品質保証とパフォーマンス管理
* **ベンチマーク戦略**: 編集・レンダリング・メモリ管理・巨大ファイル・超長行・LSP同時負荷テスト
* **テスト戦略**: プロパティベース（バッファ不変条件）、ファズ（パーサ/レンダラ）、ゴールデン（描画回帰）
* **パフォーマンス分析**: ホットパス特定（レンダリング/入力/メモリ管理）、フレームタイム可視化
* **メモリ管理設計**: Rustの所有権システム活用、アリーナアロケータ、タイピング遅延最小化

### 配布と運用（低優先度）
* **ライセンス方針**: GPL互換性を考慮（Emacsエコシステムとの関係性）
* **パッケージング**: 主要ディストリビューション対応（Nixpkgs優先、Homebrew、winget、Flatpak）
* **設定管理**: dotfiles連携、組織向け設定テンプレート、設定移行ガイド
* **ドキュメンテーション**: 入門ガイドから拡張APIまでの包括的ドキュメント体系

### 低優先度機能（後回し候補）
- **TRAMP互換機能**: リモートファイル編集の完全実装
- **統合ターミナル**: エディタ内組み込みターミナルエミュレータ
- **高度な組版機能**: 双方向テキスト、縦書き、複雑なレイアウト（当初は左→右に限定）

## はじめに

### 前提条件
- Rustツールチェーン
- NixOS環境（主要対象）
- 色対応ターミナル

### プロジェクト状況
- **現在のフェーズ**: MVP実装開始
- **完了済み**: アーキテクチャ設計、基本モジュール構造実装
- **次のステップ**: ギャップバッファ設計とMVP機能実装
- **ライセンス**: 未定

### タスク管理フロー
**altre**プロジェクトでは以下のタスク管理フローを採用しています：

1. **作業開始時**: `tasks/todo/` → `tasks/proceeding/` に移動
2. **作業完了時**: `tasks/proceeding/` → `tasks/done/` に移動
3. **進捗記録**: README.mdの「最新の進捗状況」セクションに記録

#### 現在の作業状況
- **進行中タスク**: なし
- **次回実施予定**: ギャップバッファ設計またはMVP実装タスクから選択

#### タスク管理の例
```bash
# 作業開始時の例
mv tasks/todo/design/02_gap_buffer_design.md tasks/proceeding/

# 作業完了時の例
mv tasks/proceeding/02_gap_buffer_design.md tasks/done/
```

#### 完了済みタスク
- **01_architecture_design.md** (2025-01-28 完了)
  - MVPアーキテクチャ設計書作成
  - モジュール依存関係図の作成
  - 基本モジュール構造のスケルトン実装
  - 65個のテスト実装・実行成功
  - 完全なコンパイル・動作確認完了
- **02_error_handling_implementation.md** (2025-09-22 完了)
  - 統一エラー型とエラーメッセージ辞書の実装
  - ロギングモジュールとパニックハンドラの導入
  - エラーレポート生成と関連テストを整備
- **03_gap_buffer_implementation.md** (2025-09-22 完了)
  - ギャップバッファAPIとUTF-8安全な挿入・削除処理を実装
  - 文字境界キャッシュと行開始位置計算を追加
  - proptestベースの比較テストとベンチマークを整備
- **04_keybinding_implementation.md** (2025-09-22 完了)
  - ModernKeyMapとAction→Command変換を実装しイベント処理を刷新
  - crossterm連携やC-xプレフィックス、システムキーキャンセルを統合
  - Tabなどの入力やプロパティテストを拡充
- **13_code_integration_and_cleanup.md** (2025-09-22 完了)
  - `crate::error::Result`でエラー戻り値を統一し`EditError`→`AltreError`変換を整理
  - 未使用importの削除と`Debug`実装の整備を実施
  - `cargo build --offline`/`cargo test --offline`でクリーンな実行結果を確認
- **14_gap_buffer_property_tests.md** (2025-09-22 完了)
  - ギャップバッファの不変条件・操作・エラーパスをカバーするproptestを追加
  - `operation_strategy`/`small_unicode_string`でUTF-8安全なデータ生成を共通化
  - `cargo test gap_buffer --offline` と `PROPTEST_CASE_SEED` による再現手順を整備
- **16_navigation_performance_tests.md** (2025-09-22 完了)
  - `NavigationPerformanceTestHarness`で中央値/平均/最大を評価する性能テストを追加
  - 短行・長行・巨大バッファ・タブ幅変換シナリオを `cargo test --offline` で検証
  - `cargo bench navigation_bench --offline` によりベンチマーク経路も確認
- **15_minibuffer_test_suite.md** (2025-09-22 完了)
  - ミニバッファの単体・履歴・補完・統合・エラー検証テストを追加
  - TempDirベースの補完用フィクスチャとキー入力ヘルパーを整備
  - `cargo test minibuffer --offline` で安定成功することを確認
- **17_search_replace_specification_analysis.md** (2025-09-27 完了)
  - Emacs検索・置換機能を分析しaltre向け仕様を策定
  - `docs/design/search_replace_spec.md` にMVP範囲と非機能要件を文書化
  - キーバインドとキャンセル/折り返し挙動を定義
- **18_incremental_search_architecture_design.md** (2025-09-27 完了)
  - インクリメンタル検索モジュール構成と状態遷移を設計
  - `docs/design/incremental_search_architecture.md` を新規作成
  - 差分マッチングとUI統合フローを整理
- **19_search_replace_data_structures.md** (2025-09-27 完了)
  - 検索アルゴリズム選択戦略とキャッシュ設計を確立
  - `docs/design/search_data_structures.md` にデータ構造仕様を記述
  - 差分更新・大規模テキスト対応の方針をまとめる
- **20_search_replace_ui_ux_design.md** (2025-09-27 完了)
  - ミニバッファ表示・ハイライト設計を策定
  - `docs/design/search_ui_ux.md` を新規作成
  - 状態別メッセージとアクセシビリティ要件を定義
- **21_incremental_search_implementation.md** (2025-09-27 完了)
  - `app/src/search/` にインクリメンタル検索エンジンと状態管理を実装
  - C-s/C-r 等のキーバインドをアプリに統合し検索UI/ハイライトを描画
  - `cargo test -- --test-threads=1` で全テストを確認

### 関連ドキュメント
- **詳細仕様**: `QA.md` - プロジェクト仕様と開発決定事項
- **タスク管理**: `TASK_MANAGEMENT.md` - タスク管理方法とディレクトリ構成
- **タスク実行状況**: `tasks/` - 開発タスクの進行状況管理
- **設計資料**: `docs/` - アーキテクチャと設計ドキュメント
- **マニュアル**: `manuals/` - ユーザー・開発者向けガイド

---

**altre** - 日本語で記述された現代的なEmacs風テキストエディタプロジェクト
