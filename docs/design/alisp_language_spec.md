# alisp v0 言語仕様書

## 1. 概要
- 本書は alisp 初期実装 (v0) の言語仕様を定義する。
- 仕様は QA.md (Q1〜Q7) の回答と docs/adr/0004-alisp-first-draft.md をもとに整理した。
- 実装対象はミニバッファからの即時評価を想定した最小構成であり、将来拡張項目は制限事項として明記する。

## 2. 参照資料
- QA.md: Q1, Q2, Q4, Q5, Q6, Q7
- docs/adr/0004-alisp-first-draft.md
- docs/design/minibuffer.md (ミニバッファ UX 基準) ※将来復元予定

## 3. 言語の基本方針
- Lisp-1: 値と関数を同一名前空間で管理する。
- 評価戦略: 呼び出し前評価（正格評価）。
- スコープ: レキシカルスコープ。
- 実行エントリポイント: ミニバッファからの一行評価 (`alisp-eval-expression` 仮称) のみ。
- インタラクティブコマンド、キーバインド連携、外部ファイル読み込みは v0 では未実装。

## 4. データ型
| 型名 | 説明 | リテラル例 | 備考 |
|------|------|------------|------|
| 整数 `Integer` | 64bit 有符号整数 | `0`, `-42`, `12345` | 範囲外は `RuntimeError(IntegerOverflow)` |
| 浮動小数 `Float` | 64bit 浮動小数 (IEEE 754) | `3.14`, `-0.5`, `1e-3` | 整数との暗黙変換なし |
| 真偽値 `Boolean` | 真理値 | `#t`, `#f` | `#f` のみ偽扱い、その他は真 |
| 文字列 `String` | UTF-8 文字列 | `"hello"`, `"こんにちは"` | エスケープ: `\n`, `\t`, `\"`, `\\` |
| シンボル `Symbol` | 識別子 | `add`, `my-var` | 評価時に束縛を参照 |
| 関数 `Function` | ユーザー定義／プリミティブ | （リテラル無し） | `lambda` またはプリミティブ登録で生成 |
| 単位 `Unit` | 値なし | `()` と表示 | 副作用のみの結果に使用 |

### 非対応 (v0)
- リスト／ベクタ／ハッシュテーブルはユーザー定義値として提供しない（QA Q6）。
- `nil` は予約済みだが v0 では値を持たない。
- マクロ／クォート／アンコートは未実装。

## 5. 構文
### 5.1 S 式
```
<form>        ::= <atom> | <list>
<atom>        ::= <number> | <boolean> | <string> | <symbol>
<list>        ::= '(' <form>* ')'
```
- リストは構文上の表現であり、データとして操作する機能は提供しない。
- コメントは `;` から行末まで無視する。
- ホワイトスペース（空白・改行・タブ）でトークンを区切る。

### 5.2 シンボル命名規則
- 使用可能文字: アルファベット、数字、`- _ + * / ? !`。
- 先頭を数字にすることは不可。
- 予約語: `define`, `lambda`, `let`, `if`, `begin`, `set!`, `#t`, `#f`。

### 5.3 文字列
- ダブルクォートで囲む。
- 文字列中のバックスラッシュは `\\` で表現。

## 6. 評価規則
### 6.1 一般規則
1. リストの先頭要素を評価する。
2. 結果が関数であれば残りの引数を左から順に評価し、関数へ渡す。
3. 結果が特殊フォーム識別子であれば、そのフォーム固有の規則に従う。

### 6.2 特殊フォーム
| フォーム | 形式 | 説明 |
|----------|------|------|
| `define` | `(define name expr)` | `expr` を評価して `name` へ束縛。既存名は上書き可。 |
|          | `(define (fn-name params...) body...)` | 関数定義の糖衣構文。`lambda` を生成。 |
| `lambda` | `(lambda (param1 param2 ...) body...)` | 無名関数を生成。ボディは複数式可。最後の式の値を返す。 |
| `let`    | `(let ((name expr) ...) body...)` | 右辺を外側の環境で評価し、新環境で束縛して `body` を評価。束縛は同時確定。 |
| `if`     | `(if test then-expr else-expr)` | `test` を評価し、`#f` なら `else-expr` を、その他は `then-expr` を評価。 |
| `begin`  | `(begin expr1 expr2 ... exprN)` | 順に評価し、最後の値を返す。 |
| `set!`   | `(set! name expr)` | 既存の束縛を更新。未定義名は `NameError`。 |

- 上記以外のフォームは v0 では予約されていない。
- 特殊フォームの引数チェック・エラー処理は評価器設計に従う。

### 6.3 関数呼び出し
- `(callee arg ...)` の形。
- `callee` を評価し、`Function` 値を得る。プリミティブ／ユーザー関数以外は `TypeError`。
- 引数は左から正格評価。個数不一致は `ArityError`。
- ユーザー関数は新しいレキシカル環境を生成し、仮引数へ値を束縛して `body` を順に評価。

### 6.4 真偽規則
- `#f` のみ偽。その他の値は真として扱う。
- `and`/`or` は短絡評価を行う。空の `and` は `#t`、空の `or` は `#f` を返す。

## 7. 標準環境 (プリミティブ)
### 7.1 数値演算
| 名称 | 説明 |
|------|------|
| `+`, `-`, `*`, `/` | 数値演算。整数と浮動小数は同型同士でのみ演算可。除算で 0 を渡すと `RuntimeError(DivisionByZero)`。
| `=` , `<`, `<=`, `>` , `>=` | 比較演算。真偽値を返す。 |
| `abs`, `floor`, `ceil` | 数値補助関数。 |

### 7.2 論理演算
| 名称 | 説明 |
|------|------|
| `not` | 真偽値反転。 |
| `and`, `or` | 短絡論理。 |

### 7.3 文字列
| 名称 | 説明 |
|------|------|
| `string-append` | 文字列結合。 |
| `string-length` | Unicode スカラ値数を返す。 |

### 7.4 メタ
| 名称 | 説明 |
|------|------|
| `type-of` | 渡された値の型名を文字列で返す。 |
| `print` | 値を文字列化してミニバッファへ出力。戻り値は `()` 。 |

- 追加のホスト連携プリミティブは v0 では提供しない。
- プリミティブの変換エラーは `RuntimeError` として報告する。

## 8. エラー仕様
| 種別 | 発生条件 | 表示例 |
|------|----------|--------|
| `ReaderError` | 字句解析・構文解析失敗 | `alisp error: reader - unexpected token ')'` |
| `NameError` | 未定義シンボル参照 | `alisp error: name - undefined symbol foo` |
| `ArityError` | 引数個数不一致 | `alisp error: arity - expected 2 args, got 1` |
| `TypeError` | 型不一致 | `alisp error: type - expected number, got string` |
| `RuntimeError` | プリミティブ内部のその他エラー | `alisp error: runtime - division by zero` |

- エラーはミニバッファに表示し、詳細はログへ出力可能とする（任意）。
- エラー発生時は評価を中断し、`()` を返す。

## 9. 制限事項
- データ型: リスト／ベクタ／ハッシュテーブル未実装。
- メタ構文: マクロ・クォート・アンコート未実装。
- 評価経路: ミニバッファ評価のみ (`eval-buffer` / `eval-region` は未提供)。
- パッケージ／モジュール機構、外部ファイル読み込み、REPL 継続等は未対応。
- GC 方式は別途設計書を参照。ユーザーが直接制御する手段はない。

## 10. 将来拡張
- データ型拡張: リスト → ハッシュテーブル → ベクタの順で導入予定 (QA Q6)。
- メタ構文: `quote`, `quasiquote`, `macro` 系の導入を検討。
- 評価経路: `eval-buffer`, `eval-region`, ファイルロード、REPL の提供。
- ホスト連携: バッファ操作、キーバインド、プロセス管理等を段階的に公開。
- バイトコードコンパイル/VM: AST 直評価からの移行を検討 (QA Q2)。
