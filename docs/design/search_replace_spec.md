# 検索・置換仕様書

## 概要
本ドキュメントは、altreに導入するEmacsライクな検索・置換機能の仕様を定義する。Emacsのユーザー体験を踏襲しつつ、Rust + ratatuiベースのMVP段階で実現可能な機能境界を明確化することを目的とする。

## 設計背景
- MVPフェーズではテキスト編集の基礎操作を優先し、インクリメンタル検索とクエリ置換を最小構成で提供する。
- Emacsとの互換性は操作感に限り、内部実装や拡張APIはプロジェクト独自仕様とする。
- ギャップバッファを用いたテキストモデル上で高速に検索を行い、UIはミニバッファおよび本文ハイライトでフィードバックを行う。

## MVPスコープ
| 機能カテゴリ | 機能 | 備考 |
| --- | --- | --- |
| 検索 | 前方インクリメンタル検索（`C-s`） | リアルタイムでマッチ位置にカーソル移動、折り返し通知 |
| 検索 | 後方インクリメンタル検索（`C-r`） | カーソル位置から後方へ検索、折り返し対応 |
| 検索 | 検索語編集 | 文字追加・Backspaceによる削除、`C-w`で単語追加 |
| 検索 | 終了/キャンセル | `Enter`で確定、`C-g`でキャンセルし開始位置へ復帰 |
| 検索 | 失敗フィードバック | マッチ未発見時にミニバッファで失敗表示（非致命的） |
| 置換 | クエリ置換（`M-%`） | 逐次確認、`y`/`n`/`!`/`q`/`C-g` をサポート |
| 置換 | 正規表現クエリ置換（`C-M-%`） | `$1`などのキャプチャ参照／一括置換対応 |
| ハイライト | 現在マッチ＋その他マッチ表示 | ratatui上で強調色を切替（現在マッチは強調、他は弱調） |
| 状態管理 | 検索履歴（セッション限定） | MVPでは最新1件のみ保持、履歴一覧は将来対応 |

### 非対象（将来拡張）
- 正規表現インクリメンタル検索（`C-M-s`/`C-M-r`）
- 複数バッファ横断検索
- 矩形置換、条件付き置換
- 検索語履歴の永続化

## キーバインド仕様
| キー | コマンド | 効果 |
| --- | --- | --- |
| `C-s` | `search.forward` | 前方インクリメンタル検索を開始/次マッチへ移動 |
| `C-r` | `search.backward` | 後方インクリメンタル検索を開始/前マッチへ移動 |
| `C-w` | `search.yank-word` | カーソル位置の単語を検索語へ追加 |
| `Backspace` | `search.delete-char` | 検索語末尾文字を削除し再検索 |
| `Enter` | `search.accept` | 現在マッチ位置で検索終了 |
| `C-g` | `search.cancel` | 検索前のカーソル位置へ復帰し検索終了 |
| `M-%` | `replace.query` | クエリ置換開始 |
| `y` / `SPC` | `replace.accept` | マッチ箇所を置換し次へ移動 |
| `n` / `DEL` | `replace.skip` | 置換せずに次へ移動 |
| `!` | `replace.accept-all` | 残りすべて置換 |
| `q` / `Enter` | `replace.quit` | クエリ置換終了 |
| `C-g` | `replace.cancel` | 置換全体をキャンセルし変更を巻き戻し |

## MVP動作要件
1. **ケースフォールディング**: 検索語がすべて小文字の場合は大文字小文字を区別せず、その他は区別する（Emacs互換）。将来、ミニバッファオプションで切替可能にする。
2. **折り返し検索**: バッファ末尾/先頭に到達した際、自動で折り返し再検索する。初回の折り返し時にはミニバッファに「検索が折り返しました」を表示し、以降は状態を維持する。
3. **失敗シグナル**: 現在の検索語でマッチが見つからない場合、ミニバッファに赤色で失敗メッセージを表示し、カーソルは動かさない。
4. **キャンセル挙動**: `C-g`押下時は検索開始位置のカーソルとマークを復元し、ハイライトを消去する。
5. **検索語履歴**: MVPでは最新1件のみ保持し、`C-s`再入力で直前の検索語を初期値として再利用する。
6. **マルチバイト対応**: UTF-8全般に対して安全に文字境界を扱う。検索語はUnicodeスカラー値列として扱い、結合文字は正規化オプションが無効な限り逐次一致を行う。
7. **置換確認**: クエリ置換ではミニバッファに `Replace "foo" with "bar"? (y, n, !, q, C-g)` 形式でプロンプトを表示し、置換済み件数と残り件数を逐次更新する。正規表現モードでは `$1` などのキャプチャを展開したプレビューを提示する。
8. **検索との連携**: インクリメンタル検索で直前に使用したパターンや選択中のリージョンは、クエリ置換開始時の初期値として自動投入される。

## ユースケースフロー
1. **前方インクリメンタル検索**
   1. `C-s`で検索開始 → 検索状態初期化、開始位置保存
   2. 文字入力ごとに再マッチング → マッチ時はカーソル移動、ハイライト更新
   3. `Enter`で確定 → 現在位置維持、状態終了
2. **検索キャンセル**
   1. 検索中に`C-g` → 状態破棄、カーソル復元
3. **クエリ置換**
   1. `M-%`で検索語入力（ミニバッファ）
   2. 置換語入力後、順次マッチ箇所へフォーカス
   3. `y`/`n`で選択、`!`で一括確定、`q`で早期終了

## 非機能要件
- **応答性**: 検索語1文字入力あたり100ms以内に結果を反映（テキストサイズ1MB未満を想定）。
- **メモリ使用量**: 検索結果キャッシュは最大100件（画面表示分）をMVP上限とし、それ以上は遅延取得する。
- **エラー処理**: 正規表現未サポートのため、メタ文字を含む入力でもリテラルとして扱いエラーにしない。

## 依存関係・先行タスク
- `docs/design/minibuffer.md` に基づくミニバッファAPI
- `docs/design/keybinding.md` に基づくコマンド登録
- `docs/design/navigation.md` のカーソル位置管理

## 将来拡張の検討事項
- 正規表現検索・置換の導入（regexクレート統合）
- 検索履歴の永続化とヒストリUI
- マーク／リージョンとの連携（置換範囲限定）
- alispからの検索API公開
