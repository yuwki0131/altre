# 検索・置換 UI/UX 設計

## 概要
本書は、altreの検索および置換機能に関するユーザーインターフェース設計を定義する。Emacsに近い操作感を保ちながら、ratatuiベースのTUIで視認性と操作性を両立させることが目的である。2025-09-27 時点の実装内容に合わせて更新済み。

## デザイン原則
1. **即時フィードバック**: 入力と同時に結果を表示し、状態変化を明確に伝える。
2. **コンテキスト維持**: 検索中も本文の読みやすさを損なわず、ハイライト範囲は最小限に留める。
3. **一貫性**: 既存のミニバッファUIやメッセージ表示と統一感のある見た目にする。
4. **エラーの可視化**: 失敗時は色やラベルで明示的に通知し、ユーザーが次に取るアクションを推測しやすくする。

## ミニバッファ表示
- モード表示: `I-search:` / `I-search backward:`
- パターン表示: 入力中の検索語を白文字（成功時）、黄色（折り返し）、赤（未検出）で表示
- マッチ情報: `[現在/総数]` をグレーで表示
- 折り返し: `[wrap]` を黄色で表示
- 失敗メッセージ: `foo は見つかりません` のように赤文字で表示
- メッセージが表示されている状態でも `Ctrl+s` / `Ctrl+r` を押せば即座に検索モードに切り替わる（アプリ側で自動消去）

## 本文ハイライト
- `SearchHighlight` を `TextArea::prepare_lines` で `Span` に変換
  - 現在マッチ: 背景シアン、文字色黒、太字
  - その他マッチ: 背景 `Color::Rgb(0, 80, 80)`, 文字色白
- ハイライトは表示範囲のみ描画し、スクロール時に再計算

## 入力フロー
1. `C-s` / `C-r` で検索開始
   - 直前の検索語が再利用される
   - メッセージ表示中の場合は同時に消去される
2. 文字を入力すると即座に結果とハイライトが更新
3. `C-s` / `C-r` で次/前マッチへ移動（折り返し時は `[wrap]` 表示）
4. `C-w` でカーソル位置の単語を検索語に追加
5. `Enter` で検索を確定、`C-g` でキャンセルして開始位置に戻す

## 失敗時の挙動
- マッチが存在しない場合 `SearchStatus::NotFound` として赤いメッセージを表示
- カーソルは移動せず、次の入力待ち

## メッセージ消去ロジック
- 情報/エラーメッセージは `MinibufferSystem::is_message_displayed()` で判定
- 検索キー入力時にメッセージが残っていれば `SystemEvent::KeyInput` を通じて消去後、検索処理を継続

## テスト
- `app/src/search/mod.rs` のユニットテストで状態遷移を確認
- 手動動作確認: ファイル保存直後に `Ctrl+s` を押し、即時に検索モードへ移行することを確認

## 今後の改善案
- ハイライト配色のテーマ化とユーザー設定
- ミニバッファでの検索履歴ナビゲーション (`M-p` / `M-n`)
- 正規表現検索時の構文ハイライト追加

