# TUIãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­è¨ˆä»•æ§˜

## æ¦‚è¦

Altre ã‚¨ãƒ‡ã‚£ã‚¿MVPã«ãŠã‘ã‚‹ratatuiãƒ™ãƒ¼ã‚¹ã®TUIãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­è¨ˆã€‚åŠ¹ç‡çš„ãªç”»é¢æ§‹æˆã¨ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªæç”»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å®Ÿç¾ã™ã‚‹ã€‚

## è¨­è¨ˆæ–¹é‡

### åŸºæœ¬åŸå‰‡
1. **ã‚·ãƒ³ãƒ—ãƒ«ã•å„ªå…ˆ**: MVPã«å¿…è¦ãªè¦ç´ ã®ã¿ã‚’é…ç½®
2. **æ‹¡å¼µæ€§ç¢ºä¿**: å°†æ¥ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åˆ†å‰²æ©Ÿèƒ½ã«å¯¾å¿œ
3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é‡è¦–**: å·®åˆ†æ›´æ–°ã«ã‚ˆã‚‹åŠ¹ç‡çš„ãªæç”»
4. **ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£**: è‰²è¦šå¯¾å¿œã¨ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œé‡è¦–

### QAå›ç­”ã«åŸºã¥ãè¦ä»¶
- **æœ€å°ã‚µã‚¤ã‚º**: 60x15ï¼ˆåŸºæœ¬çš„ãªç·¨é›†ä½œæ¥­ãŒå¯èƒ½ï¼‰
- **è‰²å¯¾å¿œ**: 16è‰²ï¼ˆä¸€èˆ¬çš„ãªè‰²åˆ†ã‘ãŒå¯èƒ½ï¼‰
- **æ—¥æœ¬èªå¯¾å¿œ**: åŸºæœ¬ãƒ¬ãƒ™ãƒ«ï¼ˆä¸€èˆ¬çš„ãªå…¨è§’æ–‡å­—ã‚’æ­£ç¢ºã«è¨ˆç®—ï¼‰

## ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹æˆ

### å…¨ä½“æ§‹æˆ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â† Terminal Window
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚                  Minibuffer Area                       â”‚ â”‚ â† 3 lines (QA: ç”»é¢ä¸Šéƒ¨)
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚                                                        â”‚ â”‚
â”‚ â”‚                                                        â”‚ â”‚
â”‚ â”‚                Main Editor Area                        â”‚ â”‚ â† Remaining space
â”‚ â”‚                                                        â”‚ â”‚
â”‚ â”‚                                                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚                   Mode Line                            â”‚ â”‚ â† 1 line
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è©³ç´°ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä»•æ§˜

#### 1. ãƒŸãƒ‹ãƒãƒƒãƒ•ã‚¡ã‚¨ãƒªã‚¢ï¼ˆä¸Šéƒ¨ã€3è¡Œï¼‰
- **ä½ç½®**: ç”»é¢æœ€ä¸Šéƒ¨ï¼ˆQA Q7ã®å›ç­”ï¼‰
- **é«˜ã•**: 3è¡Œå›ºå®š
  - 1è¡Œç›®: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ + å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ
  - 2-3è¡Œç›®: è£œå®Œå€™è£œè¡¨ç¤ºï¼ˆæœ€å¤§50å€™è£œã€QA Q8ã®å›ç­”ï¼‰
- **è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰**:
  - `Inactive`: éè¡¨ç¤º
  - `FindFile`: "Find file: " + å…¥åŠ› + è£œå®Œ
  - `ExecuteCommand`: "M-x " + å…¥åŠ› + è£œå®Œ
  - `ErrorDisplay`: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ5ç§’é–“ã€QA Q10ã®å›ç­”ï¼‰
  - `InfoDisplay`: æƒ…å ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ3ç§’é–“ï¼‰

#### 2. ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ã‚¨ãƒªã‚¢ï¼ˆä¸­å¤®ã€å¯å¤‰ï¼‰
- **ä½ç½®**: ãƒŸãƒ‹ãƒãƒƒãƒ•ã‚¡ã¨ãƒ¢ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ³ã®é–“
- **å†…å®¹**:
  - ãƒ†ã‚­ã‚¹ãƒˆãƒãƒƒãƒ•ã‚¡å†…å®¹
  - ã‚«ãƒ¼ã‚½ãƒ«è¡¨ç¤º
  - è¡Œç•ªå·ï¼ˆå·¦ç«¯ï¼‰
  - ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ï¼ˆå³ç«¯ï¼‰
- **ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«**: å‚ç›´ãƒ»æ°´å¹³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ

#### 3. ãƒ¢ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ³ï¼ˆä¸‹éƒ¨ã€1è¡Œï¼‰
- **ä½ç½®**: ç”»é¢æœ€ä¸‹éƒ¨
- **å†…å®¹**:
  - ãƒ•ã‚¡ã‚¤ãƒ«å
  - ä¿å­˜çŠ¶æ…‹ï¼ˆå¤‰æ›´æœ‰ç„¡ï¼‰
  - ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ï¼ˆè¡Œ:åˆ—ï¼‰
  - ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æƒ…å ±

### æœ€å°ã‚µã‚¤ã‚ºå¯¾å¿œï¼ˆ60x15ï¼‰

```
60æ–‡å­—å¹… x 15è¡Œã®å ´åˆ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Find file: /path/to/file.txt                             â”‚ â† Minibuffer (1è¡Œ)
â”‚ [1] /path/to/file1.txt  [2] /path/to/file2.txt         â”‚ â† Completion (1è¡Œ)
â”‚ [3] /path/to/file3.txt                                  â”‚ â† Completion (1è¡Œ)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1 â”‚ ãƒ†ã‚­ã‚¹ãƒˆã®å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ã€‚æ—¥æœ¬èªã®è¡¨ç¤ºã‚‚  â”‚ â† Editor (10è¡Œ)
â”‚  2 â”‚ æ­£ç¢ºã«è¨ˆç®—ã•ã‚Œã‚‹ã€‚                                   â”‚
â”‚  3 â”‚ ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®: â–ˆ                                      â”‚
â”‚  4 â”‚                                                      â”‚
â”‚  5 â”‚                                                      â”‚
â”‚  6 â”‚                                                      â”‚
â”‚  7 â”‚                                                      â”‚
â”‚  8 â”‚                                                      â”‚
â”‚  9 â”‚                                                      â”‚
â”‚ 10 â”‚                                                      â”‚
â”‚ 11 â”‚                                                      â”‚
â”‚ 12 â”‚                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ test.txt [Modified] 3:15 UTF-8                          â”‚ â† Mode line (1è¡Œ)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æç”»ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

### 1. MinibufferWidget
```rust
pub struct MinibufferWidget<'a> {
    state: &'a MinibufferState,
    style: &'a MinibufferStyle,
}

impl<'a> Widget for MinibufferWidget<'a> {
    fn render(self, area: Rect, buf: &mut Buffer) {
        match &self.state.mode {
            MinibufferMode::Inactive => {
                // ç©ºç™½è¡¨ç¤º
            }
            MinibufferMode::FindFile | MinibufferMode::ExecuteCommand => {
                self.render_input_mode(area, buf);
            }
            MinibufferMode::ErrorDisplay { message, .. } => {
                self.render_message(area, buf, message, Color::Red);
            }
            MinibufferMode::InfoDisplay { message, .. } => {
                self.render_message(area, buf, message, Color::Green);
            }
        }
    }
}
```

### 2. EditorWidget
```rust
pub struct EditorWidget<'a> {
    buffer: &'a TextBuffer,
    cursor: CursorPosition,
    viewport: ViewportState,
    style: &'a EditorStyle,
}

impl<'a> Widget for EditorWidget<'a> {
    fn render(self, area: Rect, buf: &mut Buffer) {
        // è¡Œç•ªå·è¡¨ç¤º
        self.render_line_numbers(area, buf);

        // ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹è¡¨ç¤º
        self.render_text_content(area, buf);

        // ã‚«ãƒ¼ã‚½ãƒ«è¡¨ç¤º
        self.render_cursor(area, buf);

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼è¡¨ç¤º
        self.render_scrollbar(area, buf);
    }
}
```

### 3. ModeLineWidget
```rust
pub struct ModeLineWidget<'a> {
    file_info: &'a FileInfo,
    cursor_info: &'a CursorInfo,
    style: &'a ModeLineStyle,
}

impl<'a> Widget for ModeLineWidget<'a> {
    fn render(self, area: Rect, buf: &mut Buffer) {
        let content = format!(
            "{} [{}] {}:{} {}",
            self.file_info.name,
            if self.file_info.modified { "Modified" } else { "Saved" },
            self.cursor_info.line,
            self.cursor_info.column,
            self.file_info.encoding
        );

        Paragraph::new(content)
            .style(self.style.base_style)
            .render(area, buf);
    }
}
```

## è‰²å½©è¨­è¨ˆï¼ˆ16è‰²å¯¾å¿œï¼‰

### åŸºæœ¬è‰²ãƒ‘ãƒ¬ãƒƒãƒˆ
```rust
pub struct ColorScheme {
    // åŸºæœ¬è‰²ï¼ˆQA Q14: 16è‰²å¯¾å¿œï¼‰
    pub background: Color,
    pub foreground: Color,
    pub cursor: Color,
    pub selection: Color,

    // UIè¦ç´ è‰²
    pub line_number: Color,
    pub line_number_current: Color,
    pub mode_line_bg: Color,
    pub mode_line_fg: Color,

    // ãƒŸãƒ‹ãƒãƒƒãƒ•ã‚¡è‰²
    pub minibuffer_prompt: Color,
    pub minibuffer_input: Color,
    pub minibuffer_completion: Color,
    pub minibuffer_selected: Color,

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è‰²
    pub error_message: Color,
    pub warning_message: Color,
    pub info_message: Color,

    // ãƒœãƒ¼ãƒ€ãƒ¼è‰²
    pub border_normal: Color,
    pub border_focus: Color,
}

impl Default for ColorScheme {
    fn default() -> Self {
        Self {
            // åŸºæœ¬è‰²
            background: Color::Black,
            foreground: Color::White,
            cursor: Color::Yellow,
            selection: Color::Blue,

            // UIè¦ç´ è‰²
            line_number: Color::DarkGray,
            line_number_current: Color::White,
            mode_line_bg: Color::DarkGray,
            mode_line_fg: Color::White,

            // ãƒŸãƒ‹ãƒãƒƒãƒ•ã‚¡è‰²
            minibuffer_prompt: Color::Cyan,
            minibuffer_input: Color::White,
            minibuffer_completion: Color::Gray,
            minibuffer_selected: Color::Black, // èƒŒæ™¯: Blue

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è‰²
            error_message: Color::Red,
            warning_message: Color::Yellow,
            info_message: Color::Green,

            // ãƒœãƒ¼ãƒ€ãƒ¼è‰²
            border_normal: Color::DarkGray,
            border_focus: Color::Cyan,
        }
    }
}
```

## æ—¥æœ¬èªæ–‡å­—å¹…å¯¾å¿œï¼ˆåŸºæœ¬ãƒ¬ãƒ™ãƒ«ï¼‰

### æ–‡å­—å¹…è¨ˆç®—
```rust
pub fn char_width(ch: char) -> usize {
    match ch {
        // ASCIIæ–‡å­—
        '\x00'..='\x7F' => 1,

        // åˆ¶å¾¡æ–‡å­—
        '\x80'..='\x9F' => 0,

        // å…¨è§’æ–‡å­—ã®åŸºæœ¬çš„ãªåˆ¤å®šï¼ˆQA Q15ã®å›ç­”ï¼‰
        // ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠ
        '\u{3040}'..='\u{309F}' | '\u{30A0}'..='\u{30FF}' => 2,

        // CJKçµ±åˆæ¼¢å­—
        '\u{4E00}'..='\u{9FFF}' => 2,

        // å…¨è§’è¨˜å·
        '\u{FF01}'..='\u{FF60}' => 2,

        // ãã®ä»–ã¯æ±ã‚¢ã‚¸ã‚¢å¹…ç‰¹æ€§ã‚’ç°¡æ˜“åˆ¤å®š
        _ => {
            if unicode_width::UnicodeWidthChar::width(ch).unwrap_or(1) == 2 {
                2
            } else {
                1
            }
        }
    }
}

pub fn string_width(s: &str) -> usize {
    s.chars().map(char_width).sum()
}

pub fn truncate_string(s: &str, max_width: usize) -> String {
    let mut width = 0;
    let mut result = String::new();

    for ch in s.chars() {
        let ch_width = char_width(ch);
        if width + ch_width > max_width {
            break;
        }
        width += ch_width;
        result.push(ch);
    }

    result
}
```

## ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ

### ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚µã‚¤ã‚ºæ¤œå‡ºã¨èª¿æ•´
```rust
pub struct LayoutManager {
    min_width: u16,
    min_height: u16,
    current_size: (u16, u16),
}

impl LayoutManager {
    pub fn new() -> Self {
        Self {
            min_width: 60,   // QA Q13ã®å›ç­”
            min_height: 15,  // QA Q13ã®å›ç­”
            current_size: (0, 0),
        }
    }

    pub fn update_size(&mut self, width: u16, height: u16) -> Result<(), LayoutError> {
        if width < self.min_width || height < self.min_height {
            return Err(LayoutError::ScreenTooSmall { width, height });
        }

        self.current_size = (width, height);
        Ok(())
    }

    pub fn calculate_areas(&self) -> LayoutAreas {
        let (width, height) = self.current_size;

        // ãƒŸãƒ‹ãƒãƒƒãƒ•ã‚¡ã‚¨ãƒªã‚¢ï¼ˆä¸Šéƒ¨3è¡Œï¼‰
        let minibuffer_height = if height >= 20 { 3 } else { 2 };
        let minibuffer_area = Rect {
            x: 0,
            y: 0,
            width,
            height: minibuffer_height,
        };

        // ãƒ¢ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ³ã‚¨ãƒªã‚¢ï¼ˆä¸‹éƒ¨1è¡Œï¼‰
        let modeline_area = Rect {
            x: 0,
            y: height - 1,
            width,
            height: 1,
        };

        // ã‚¨ãƒ‡ã‚£ã‚¿ã‚¨ãƒªã‚¢ï¼ˆæ®‹ã‚Šï¼‰
        let editor_area = Rect {
            x: 0,
            y: minibuffer_height,
            width,
            height: height - minibuffer_height - 1,
        };

        LayoutAreas {
            minibuffer: minibuffer_area,
            editor: editor_area,
            modeline: modeline_area,
        }
    }
}

pub struct LayoutAreas {
    pub minibuffer: Rect,
    pub editor: Rect,
    pub modeline: Rect,
}

#[derive(Debug, thiserror::Error)]
pub enum LayoutError {
    #[error("Screen size too small: {width}x{height}, minimum required: 60x15")]
    ScreenTooSmall { width: u16, height: u16 },
}
```

## æç”»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶

### å·®åˆ†æ›´æ–°æˆ¦ç•¥
```rust
pub struct RenderState {
    last_frame: Option<Buffer>,
    dirty_regions: Vec<Rect>,
}

impl RenderState {
    pub fn mark_dirty(&mut self, area: Rect) {
        self.dirty_regions.push(area);
    }

    pub fn should_redraw(&self, area: Rect) -> bool {
        self.dirty_regions.iter().any(|dirty| dirty.intersects(area))
    }

    pub fn clear_dirty(&mut self) {
        self.dirty_regions.clear();
    }
}

pub struct PerformanceMetrics {
    pub frame_time: Duration,
    pub render_calls: usize,
    pub buffer_updates: usize,
}

// ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™
const TARGET_FPS: u32 = 60;
const MAX_FRAME_TIME: Duration = Duration::from_millis(16); // 1/60ç§’
```

### æœ€é©åŒ–æˆ¦ç•¥
1. **éƒ¨åˆ†æ›´æ–°**: å¤‰æ›´ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆè¡Œã®ã¿å†æç”»
2. **ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æœ€é©åŒ–**: ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆå¤–ã®ãƒ†ã‚­ã‚¹ãƒˆã¯æç”»ã—ãªã„
3. **æ–‡å­—å¹…ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: è¨ˆç®—æ¸ˆã¿æ–‡å­—å¹…ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
4. **ãƒãƒƒãƒ•ã‚¡ãƒ—ãƒ¼ãƒªãƒ³ã‚°**: ratatuiãƒãƒƒãƒ•ã‚¡ã®å†åˆ©ç”¨

## çµ±åˆä¾‹ï¼šãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æç”»ãƒ«ãƒ¼ãƒ—

```rust
use ratatui::{
    backend::CrosstermBackend,
    Terminal,
    layout::{Constraint, Direction, Layout},
};

pub struct TuiApp {
    terminal: Terminal<CrosstermBackend<std::io::Stdout>>,
    layout_manager: LayoutManager,
    render_state: RenderState,
    color_scheme: ColorScheme,
}

impl TuiApp {
    pub fn new() -> Result<Self> {
        let backend = CrosstermBackend::new(std::io::stdout());
        let terminal = Terminal::new(backend)?;

        Ok(Self {
            terminal,
            layout_manager: LayoutManager::new(),
            render_state: RenderState::new(),
            color_scheme: ColorScheme::default(),
        })
    }

    pub fn draw(&mut self, app_state: &AppState) -> Result<()> {
        let start_time = Instant::now();

        self.terminal.draw(|frame| {
            let size = frame.size();

            // ã‚µã‚¤ã‚ºæ›´æ–°
            if let Err(e) = self.layout_manager.update_size(size.width, size.height) {
                // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                self.draw_error(frame, &e);
                return;
            }

            // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨ˆç®—
            let areas = self.layout_manager.calculate_areas();

            // å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæç”»
            self.draw_minibuffer(frame, &areas.minibuffer, &app_state.minibuffer);
            self.draw_editor(frame, &areas.editor, &app_state.editor);
            self.draw_modeline(frame, &areas.modeline, &app_state.file_info);
        })?;

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š
        let frame_time = start_time.elapsed();
        if frame_time > MAX_FRAME_TIME {
            log::warn!("Frame time exceeded target: {:?}", frame_time);
        }

        Ok(())
    }

    fn draw_minibuffer(&self, frame: &mut Frame, area: &Rect, state: &MinibufferState) {
        let widget = MinibufferWidget::new(state, &self.color_scheme);
        frame.render_widget(widget, *area);
    }

    fn draw_editor(&self, frame: &mut Frame, area: &Rect, state: &EditorState) {
        let widget = EditorWidget::new(
            &state.buffer,
            state.cursor,
            state.viewport,
            &self.color_scheme
        );
        frame.render_widget(widget, *area);
    }

    fn draw_modeline(&self, frame: &mut Frame, area: &Rect, file_info: &FileInfo) {
        let widget = ModeLineWidget::new(file_info, &self.color_scheme);
        frame.render_widget(widget, *area);
    }

    fn draw_error(&self, frame: &mut Frame, error: &LayoutError) {
        let error_text = format!("Error: {}", error);
        let paragraph = Paragraph::new(error_text)
            .style(Style::default().fg(Color::Red).bg(Color::Black));
        frame.render_widget(paragraph, frame.size());
    }
}
```

## ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### è¦–è¦šçš„å›å¸°ãƒ†ã‚¹ãƒˆ
```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_minimum_size_layout() {
        let mut layout_manager = LayoutManager::new();
        layout_manager.update_size(60, 15).unwrap();

        let areas = layout_manager.calculate_areas();

        assert_eq!(areas.minibuffer.height, 2); // æœ€å°ã‚µã‚¤ã‚ºã§ã¯2è¡Œ
        assert_eq!(areas.modeline.height, 1);
        assert_eq!(areas.editor.height, 12); // 15 - 2 - 1
    }

    #[test]
    fn test_japanese_char_width() {
        assert_eq!(char_width('a'), 1);
        assert_eq!(char_width('ã‚'), 2);
        assert_eq!(char_width('æ¼¢'), 2);
        assert_eq!(char_width('ğŸ‰'), 2);

        assert_eq!(string_width("hello"), 5);
        assert_eq!(string_width("ã“ã‚“ã«ã¡ã¯"), 10);
        assert_eq!(string_width("helloä¸–ç•Œ"), 9);
    }

    #[test]
    fn test_color_scheme_accessibility() {
        let scheme = ColorScheme::default();

        // ã‚¨ãƒ©ãƒ¼è‰²ã¯èƒŒæ™¯ã¨ååˆ†ãªã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã‚’æŒã¤
        assert_ne!(scheme.error_message, scheme.background);
        assert_ne!(scheme.info_message, scheme.background);
    }
}
```

## å°†æ¥ã®æ‹¡å¼µè¨ˆç”»

### ãƒ•ã‚§ãƒ¼ã‚º2: é«˜åº¦ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
- åˆ†å‰²ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µãƒãƒ¼ãƒˆ
- ã‚¿ãƒ–æ©Ÿèƒ½
- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«éšå±¤è¡¨ç¤ºï¼‰
- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦

### ãƒ•ã‚§ãƒ¼ã‚º3: è¦–è¦šçš„å¼·åŒ–
- ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆ
- ãƒ†ãƒ¼ãƒã‚µãƒãƒ¼ãƒˆ
- True Colorå¯¾å¿œï¼ˆé«˜å“è³ªã‚¿ãƒ¼ãƒŸãƒŠãƒ«å‘ã‘ï¼‰
- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ

### ãƒ•ã‚§ãƒ¼ã‚º4: ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£
- é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰
- æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´
- è‰²è¦šå¯¾å¿œãƒ‘ãƒ¬ãƒƒãƒˆ
- ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼å¯¾å¿œ

ã“ã®è¨­è¨ˆã«ã‚ˆã‚Šã€MVPæ®µéšã§ã®å®Ÿç”¨çš„ãªTUIã¨å°†æ¥ã®é«˜åº¦ãªæ©Ÿèƒ½ã¸ã®æ‹¡å¼µæ€§ã‚’ä¸¡ç«‹ã•ã›ã‚‹ã€‚