# alisp v0 言語マニュアル

## 1. はじめに
alisp v0 は altre のミニバッファから実行できる軽量 Lisp 方言です。本マニュアルは QA.md (Q1〜Q7) と `docs/design/alisp_language_spec.md` をもとに、v0 で利用可能な機能をまとめたものです。将来の拡張項目は制限事項として明記します。

## 2. クイックスタート
1. altre を起動し、`M-:`（Alt+`:`）でミニバッファをアクティブにします。
2. プロンプトに alisp 式を入力し、Enter で評価します。
3. 結果はミニバッファに緑色で表示されます。エラー時は赤色で内容が表示されます。

### 例: 四則演算
```
(+ 1 2 3)      ; => 6
(* 2 (- 5 1))  ; => 8
```

### 例: 関数定義と呼び出し
```
(define (square x)
  (* x x))
(square 12)    ; => 144
```

## 3. データ型とリテラル
| 型 | リテラル例 | 備考 |
|----|------------|------|
| 整数 `Integer` | `0`, `-42`, `123` | 64bit。範囲外はエラー |
| 浮動小数 `Float` | `3.14`, `1e-3` | 整数との混在演算は不可 |
| 真偽値 `Boolean` | `#t`, `#f` | `#f` のみ偽、それ以外は真 |
| 文字列 `String` | `"hello"`, `"こんにちは"` | `\n`, `\t`, `\"`, `\\` をサポート |
| シンボル `Symbol` | `foo`, `my-var` | 評価時に環境から値を取得 |
| 関数 `Function` | — | `lambda` や `define` で作成 |
| 単位 `Unit` | `()` | 副作用のみの結果 |

> **注意**: v0 ではリスト/ベクタ/ハッシュテーブルはデータ型として提供されません。リスト記法は構文としてのみ使用します。

## 4. 構文と特殊フォーム
### 4.1 S 式
- `(<演算子> <引数>...)` の形で記述します。
- コメントは `;` から行末まで。

### 4.2 予約語
`define`, `lambda`, `let`, `if`, `begin`, `set!`, `#t`, `#f`

### 4.3 特殊フォーム一覧
| フォーム | 書式 | 説明 |
|----------|------|------|
| `define` | `(define name expr)` | 評価結果をグローバルに束縛 |
|          | `(define (fn params...) body...)` | 関数定義の糖衣構文 |
| `lambda` | `(lambda (params...) body...)` | 無名関数を生成 |
| `let` | `(let ((name expr) ...) body...)` | 同時束縛後に `body` を評価 |
| `if` | `(if test then else)` | `test` が `#f` の場合のみ `else` を評価 |
| `begin` | `(begin expr1 ... exprN)` | 複数式を順に評価し最後の値を返す |
| `set!` | `(set! name expr)` | 既存束縛を上書き（未定義ならエラー） |

> **短絡演算**: `and` / `or` は通常関数ではなく特殊フォームとして実装され、左から短絡評価を行います。

## 5. 標準関数（プリミティブ）
### 5.1 数値
| 関数 | 説明 |
|------|------|
| `+`, `-`, `*`, `/` | 同型数値の演算。除算は 0 でエラー |
| `=`, `<`, `<=`, `>`, `>=` | 比較演算。真偽値を返す |
| `abs`, `floor`, `ceil` | 補助関数 |

### 5.2 論理
| 関数 | 説明 |
|------|------|
| `not` | 真偽値の反転 |
| `and`, `or` | 短絡評価。`(and)` は `#t`、`(or)` は `#f` |

### 5.3 文字列
| 関数 | 説明 |
|------|------|
| `string-append` | 文字列を結合 |
| `string-length` | 文字列長（Unicode スカラ値数） |

### 5.4 メタ
| 関数 | 説明 |
|------|------|
| `type-of` | 値の型を文字列で返す |
| `print` | 値を表示し `()` を返す |

## 6. ミニバッファでの評価手順
1. `M-:` を押下し「Eval: 」プロンプトを開く
2. 式を入力（複数行は `C-j` で改行予定。v0 では 1 行推奨）
3. Enter で評価結果を表示
4. 履歴は `↑` / `↓` キーで再利用可能
5. `C-g` で入力をキャンセル

### 応用: 定義をファイルに保存
1. `manuals/` などに Lisp スニペットを保存
2. ミニバッファ評価でコピー＆ペーストし実行
3. 将来の `load-file` 実装を待ちつつ一時的に利用可能

## 7. エラーハンドリング
| エラー種別 | 発生条件 | 表示例 |
|------------|----------|--------|
| `ReaderError` | 構文エラー | `alisp error: reader - unexpected token ')'` |
| `NameError` | 未定義シンボル | `alisp error: name - undefined symbol foo` |
| `ArityError` | 引数個数不一致 | `alisp error: arity - expected 2 args, got 1` |
| `TypeError` | 型不一致 | `alisp error: type - expected number, got string` |
| `RuntimeError` | ゼロ除算など | `alisp error: runtime - division by zero` |

- エラーは評価を中断し、戻り値は `()` になります。
- エラー発生時は入力式を確認し、必要に応じて `type-of` や `print` でデバッグしてください。

## 8. 制限事項とロードマップ
- データ構造: リストやベクタは未提供。将来拡張予定。
- I/O: ファイル操作・バッファ操作プリミティブは未実装。
- 実行経路: ミニバッファ評価のみ。`eval-buffer`, `load-file` などは v1 以降。
- マクロ・メタ構文は未実装。
- GC は内部管理のみで、ユーザーが操作する手段はありません。

## 9. チュートリアル: フィボナッチ計算
```
(define (fib n)
  (if (<= n 1)
      n
      (+ (fib (- n 1)) (fib (- n 2)))))

(fib 10) ; => 55
```
- 計算コストが高いため、大きな値ではパフォーマンスが低下します。

## 10. デバッグ Tips
- `print` は結果を `()` にするため、`begin` と組み合わせて副作用と値を同時に扱うと便利です。
- `type-of` で推測が難しい値の型を確認できます。
- 語尾の括弧を揃えるためにエディタ側の括弧ハイライト機能を活用してください。

## 11. 参考資料
- `docs/design/alisp_language_spec.md`
- `docs/design/alisp_runtime_architecture.md`
- `manuals/user_guide.md`（ミニバッファの操作方法）

alisp v0 は実験的な段階で、使い勝手のメモとして残しています。気付いた点は `tasks/` や `docs/` に自分用メモとして追記してください。
