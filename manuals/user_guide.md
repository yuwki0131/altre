# altre ユーザーガイド

## はじめに
altre は Rust と ratatui で実装された Emacs 風テキストエディタです。本ガイドは MVP 版 TUI を対象とし、初めて altre を利用するユーザーが基本操作から日常利用までを迷わず行えるように構成されています。

## 1. 動作環境と準備
- **対応 OS**: Linux / macOS（端末上での動作を想定）
- **依存関係**: Rust 1.74 以降、`cargo`、UTF-8 対応ターミナル、真のカラー表示が可能な端末
- **初回ビルド**: リポジトリ直下で `cargo build --release`
- **起動前チェック**:
  - 端末のフォントが等幅である
  - ロケールが UTF-8（`locale` コマンドで確認）
  - 書き込み対象ディレクトリに十分な権限がある

## 2. アプリケーションの起動と終了
### 起動
```bash
cargo run
```
- 初回起動時はワークスペースのカレントディレクトリがバッファ名 "*scratch*" として開かれます。
- ターミナルが raw mode に入るため、他アプリのショートカットは無効になります。

### 終了
- `C-x C-c`（`Ctrl` + `x` → `Ctrl` + `c`）で終了確認を行わず即座に終了します。
- 未保存のバッファがある場合は、保存してから終了することを推奨します。

## 3. 画面構成
- **ミニバッファ**（画面上部）: プロンプト、補完候補、メッセージを表示します。必要に応じて最大 10 行まで拡張します。
- **エディタ領域**: バッファ内容とカーソル位置を表示します。行番号が左端に表示されます。
- **モードライン**（画面最下部）: 現在のファイル名、変更有無、カーソル位置、文字コードを表示します。

## 4. ファイル操作
### ファイルを開く
1. `C-x C-f` を押下する
2. ミニバッファに "Find file:" が表示される
3. パスを入力（Tab で補完、`C-g` でキャンセル）
4. Enter で確定するとバッファに読み込まれます

### ファイルを保存
- 既存ファイル: `C-x C-s` → 変更があれば即保存し、ミニバッファに "保存しました" メッセージが表示されます。
- 新規ファイル: `C-x C-s` 実行後に保存先の入力が求められます。デフォルトでカレントディレクトリとバッファ名を組み合わせたパスが提案されます。
  1. ミニバッファに "Save file:" が表示される
  2. 保存したいパスを入力し Enter
  3. 正常終了でモードラインが更新されます

### 別名保存（Save As）
- `M-x write-file` または `M-x save-buffer-as`
- 直接 `write-file ~/path/to/name.txt` と入力しても保存できます

## 5. 基本編集操作
| 操作 | ショートカット | 説明 |
|------|----------------|------|
| 文字入力 | 文字キー | 挿入モードは常時オンです |
| 改行 | `Enter` | 現在位置で改行 |
| 1 文字削除（後退） | `Backspace` または `C-h` | カーソルの左側を削除 |
| 1 文字削除（前方） | `C-d` | カーソルの右側を削除 |
| 行の先頭へ | `C-a` | 現在行の先頭に移動 |
| 行の末尾へ | `C-e` | 現在行の末尾に移動 |
| 1 行上へ | `C-p` / `↑` | |
| 1 行下へ | `C-n` / `↓` | |
| 1 文字左へ | `C-b` / `←` | |
| 1 文字右へ | `C-f` / `→` | |
| バッファ先頭へ | `M-<` | |
| バッファ末尾へ | `M->` | |
| 単語末尾へ | `M-f` | 次の単語まで移動 |
| 単語先頭へ | `M-b` | 前の単語へ移動 |
| ページスクロール（下） | `C-v` | 画面を 1 ページ分下にスクロール（カーソルも追従） |
| ページスクロール（上） | `M-v` | 画面を 1 ページ分上にスクロール |
| 画面再配置 | `C-l` | カーソル行を中央→上→下の順に配置 |
| 単語削除（前方） | `M-d` | カーソル以降の単語と前の空白を削除 |
| 単語削除（後方） | `M-Backspace` | カーソル以前の単語と空白を削除 |
| 行末まで削除 | `C-k` | カーソル位置から行末（改行を含む）まで削除しキルリングへ保存 |
| ヤンク（貼り付け） | `C-y` | キルリングの最新エントリを貼り付け |
| ヤンク履歴巡回 | `M-y` | 直前のヤンクをキルリング内の次エントリで置き換え |
| 横スクロール（右側を表示） | `C-x <` | 画面を左へスクロールし右側の列を表示 |
| 横スクロール（左側を表示） | `C-x >` | 画面を右へスクロールし左側の列を表示 |
| キャンセル | `C-g` | 進行中の操作を強制的に中断し、状態をリセット |

### ウィンドウ操作
| 操作 | ショートカット | 説明 |
|------|----------------|------|
| ウィンドウを上下に分割 | `C-x 2` | 現在のウィンドウを上下に分割し、同じバッファを表示 |
| ウィンドウを左右に分割 | `C-x 3` | 現在のウィンドウを左右に分割 |
| 現在のウィンドウのみ表示 | `C-x 1` | フォーカス中のウィンドウ以外を閉じる |
| 現在のウィンドウを閉じる | `C-x 0` | フォーカス中のウィンドウを閉じ、残りのウィンドウへ切り替え |
| 次のウィンドウに移動 | `C-x o` | 分割済みウィンドウ間を巡回 |

> 現時点では表示中のバッファはすべてのウィンドウで共通です。異なるバッファを同時表示する機能は将来の拡張項目です。

### バッファ操作
| 操作 | ショートカット | 説明 |
|------|----------------|------|
| バッファを切り替え | `C-x b` | バッファ名を入力して切り替え。初期値は直前に使用したバッファ |
| バッファを削除 | `C-x k` | 指定バッファを閉じる（未保存の場合はエラー表示） |
| バッファ一覧を表示 | `C-x C-b` | 開いているバッファの一覧をミニバッファに表示 |

## 6. ミニバッファ操作
- **呼び出し方法**: `C-x C-f`、`C-x C-s`、`M-x`、`M-:` などで自動的にミニバッファがアクティブになります。
- **補完**: Tab でパスやコマンドの補完候補を表示。補完候補リストは `↑` `↓` で移動、Enter で決定。
- **キャンセル**: `C-g`（入力中の処理を即座に中断）
- **エラー表示**: 赤字で表示され 5 秒後に自動消滅。任意キー入力でも閉じられます。
- **情報表示**: 保存成功などのメッセージは 3 秒で消えます。

## 7. 検索（インクリメンタルサーチ）
- **開始**: `C-s`（前方） / `C-r`（後方）。直前の検索語があれば自動で挿入されます。
- **入力**: 文字を入力すると即座に結果が絞り込まれ、カーソルとハイライトが更新されます。
- **移動**: 検索中に `C-s` / `C-r` で次/前マッチへ移動。端に到達すると折り返し `[wrap]` を表示。
- **単語追加**: `C-w` でカーソル位置の単語を検索語に追加。
- **終了/キャンセル**: `Enter` で確定、`C-g` で検索開始位置に戻って中断。
- **メッセージ**: マッチがない場合は赤文字で "○○ は見つかりません" と表示。
- **備考**: ファイル保存直後などで情報メッセージが表示されていても `C-s` で即検索に移行できるようアプリ側で自動消去されます。

## 8. 置換（準備中）
- `M-%` でクエリ置換モードに入る（将来実装予定）。

## 9. コマンド実行 (`M-x`)
1. `Alt` + `x`（`M-x`）を押す
2. コマンド名を入力（例: `write-file`）
3. Enter で実行
- コマンド履歴: `↑` `↓` で過去の入力を再利用可能

## 10. eval-expression (`M-:`)
- `Alt` + `:` を押すと alisp 式を入力できます。
- 成功すると結果がミニバッファに緑色で表示されます。エラー時は赤字で詳細が表示されます。

## 11. トラブルシューティング概要
- raw mode に入れず起動に失敗: 端末が raw mode を拒否している可能性。別ターミナル、または `TERM` の設定を確認。
- 保存できない: パスが存在するか、書き込み権限があるか確認。詳細は `manuals/troubleshooting.md` 参照。
- 検索が反応しない: `C-s`/`C-r` を押しても反応が無い場合、旧バージョンを利用している可能性があります。最新版を再ビルドしてください。

## 12. ユーザー向け Tips
- `C-g` は「やり直し」の万能キャンセルです。
- ページスクロールは `C-v` / `M-v`、再配置は `C-l` を繰り返すと中央→上→下と切り替わります。
- 重要なファイルは `write-file` で別名保存してから編集すると安全です。
- 補完候補は最大 50 件まで表示されます。候補が多い場合はさらに文字を打ち込んで絞り込みましょう。

## 13. サポートとフィードバック
- 不具合報告や改善提案は GitHub Issue へ。
- マニュアルの不備は `manuals/faq.md` に追記し、Pull Request を送ってください。

---
このガイドは MVP 時点の仕様に基づいています。将来的な GUI 版（Tauri）では操作方法が変わる可能性がありますので、最新情報は公式ドキュメントをご確認ください。
