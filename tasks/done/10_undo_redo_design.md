# Undo/Redo 機能設計

## タスク概要
線形の Undo/Redo 機能を設計し、C-/ で Undo、C-. で Redo を実行できるようにするための設計指針をまとめる。

## 目的
- MVP エディタに必要な履歴管理の要件定義
- 既存の編集コマンド群との連携方式を明確化
- 将来の機能拡張（複数ウィンドウ / 複数バッファ）に耐えられる設計基盤を整備

## 設計対象
1. **履歴モデル**
   - 操作履歴のデータ構造（スタック構成、ノード内容）
   - バッファ単位での管理か、グローバル管理か
   - Undo/Redo 時の更新フロー

2. **履歴の記録単位**
   - 文字挿入・削除・ペースト等の粒度
   - 連続入力のまとめ方（コマンド単位 / 文字単位）
   - システムイベント（ファイル保存等）を履歴に含めるか

3. **既存コンポーネントとの統合**
   - `CommandProcessor` / `TextEditor` / `KillRing` との役割分担
   - ミニバッファ経由のコマンド実行時の扱い
   - バッファ切替時の履歴管理

4. **パフォーマンスとメモリ**
   - 履歴保持件数の制御
   - 大規模編集時の挙動（しきい値やスナップショット戦略）

## 成果物
- `docs/design/undo_redo.md`（新規）へ設計方針・データ構造・シーケンス図を記述
- 設計レビューのためのメモ / ダイアグラム

## QA 確認事項
- 履歴の適用範囲（バッファ単位 vs グローバル）
- 連続文字入力をどのようにまとめるか
- バッファを閉じる/再オープン時の履歴扱い

## 完了条件
- [x] 履歴モデルと記録単位の決定
- [x] 主要編集コマンドと Undo/Redo の連携方式が明文化されている
- [x] 既存コンポーネントとの責務分担が整理されている
- [x] `docs/adr-qa/undo_redo_QA.md` に不明点が記載され、回答方針が決まっている

## 進捗メモ
- `docs/design/undo_redo.md` を追加し、線形スタック方式（Undo/Redo）と履歴エントリ/AtomicEdit の構造、カーソル復元手順、`CommandProcessor`・`TextEditor`・`App` との連携方法を整理。
- `docs/adr-qa/undo_redo_QA.md` に線形履歴など未確定だった論点を追記し、すべて回答済み。

## 見積もり
**期間**: 2 日
**優先度**: 高（安全な編集体験の必須要素）

## 関連タスク
- 25_undo_redo_implementation.md（実装タスク）
- docs/design/alisp_runtime_architecture.md（コマンド統合の参考）
