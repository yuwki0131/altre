# altreエディタの不具合と不足機能の整理

## 概要
本ドキュメントは、altre テキストエディタおよび altre lisp の現状を分析し、機能実装上の不具合、テキストエディタとしての不足機能、altre lisp の不足部分を体系的に整理したものである。

作成日: 2025-01-28

## 1. 確認済みのバグ・不具合

### 1.1 alisp インタプリタの再帰呼び出し不具合
**状態**: 未修正  
**優先度**: 高  
**タスクファイル**: `tasks/todo/bugs/2510-recrusive-reference.md`

**問題の詳細**:
- 再帰的な関数定義が正しく動作しない
- `(define (fib n) ...)` 形式で定義された関数内で自身を再帰呼び出しできない
- 例: フィボナッチ数列の計算 `(fib 10)` が失敗する

**原因分析**:
現在の実装では、`define` 特殊フォームが以下の順序で処理される:
1. 関数本体（closure）を現在の環境で作成
2. 関数名を環境に束縛

この順序では、closure 作成時に関数名がまだ環境に存在しないため、再帰呼び出しが解決できない。

**修正方針**:
関数定義の順序を変更し、先に関数名を未初期化値（または仮の値）で環境に定義してから closure を作成する。これにより closure が関数名を含む環境をキャプチャできる。

**影響範囲**:
- `app/src/alisp/evaluator.rs` の `eval_define` メソッド
- `app/src/alisp/runtime/mod.rs` の環境管理機能

**関連ファイル**:
- `app/src/alisp/evaluator.rs` (行123-157)
- `app/src/alisp/runtime/mod.rs` (行319-343)

---

### 1.2 Kill Ring と OS クリップボードの非連動
**状態**: 未実装  
**優先度**: 中  
**タスクファイル**: `tasks/todo/bugs/2510-killring-link.md`

**問題の詳細**:
- Emacs 風の kill ring（`C-w`, `M-w`, `C-y`）は実装されている
- OS のクリップボード（コピー＆ペースト）との連携が未実装
- kill した内容を他のアプリケーションにペーストできない
- 逆に、他のアプリからコピーした内容を yank できない

**修正方針**:
1. Emacs と OS クリップボードの連携仕様を調査・整理
2. `arboard` や `cli-clipboard` などのクレートを使用してクリップボード統合を実装
3. kill 時に OS クリップボードにも内容をコピー
4. yank 時に kill ring が空なら OS クリップボードから取得

**影響範囲**:
- `app/src/editor/kill_ring.rs`
- 新規モジュール: `app/src/system/clipboard.rs` (作成予定)

**依存関係**:
- 外部クレート追加が必要（例: `arboard = "3.3"`）

---

## 2. テキストエディタとしての不足機能

### 2.1 検索・置換機能の未実装

#### 2.1.1 クエリ置換（M-%）
**状態**: 未実装  
**優先度**: 高  
**タスクファイル**: `tasks/todo/mvp/22_replace_functionality_implementation.md`

**不足している機能**:
- インタラクティブな置換確認機能
- 置換操作キー（y/n/!/q/^/C-g）
- 置換のアンドゥ・リドゥ
- 一括置換機能

**設計資料**: `docs/design/search_replace_spec.md`

**実装予定内容**:
- `app/src/search/replace.rs` - 置換エンジン
- `app/src/search/replace_state.rs` - 置換状態管理
- `app/src/search/replace_ui.rs` - 置換UI統合
- `app/src/search/replace_commands.rs` - 置換コマンド実装

---

#### 2.1.2 正規表現検索・置換（C-M-s, C-M-r, C-M-%）
**状態**: 未実装  
**優先度**: 中  
**タスクファイル**: `tasks/todo/mvp/23_regex_search_replace_implementation.md`

**不足している機能**:
- 正規表現パターンによる検索
- 正規表現パターンマッチング置換
- キャプチャグループの参照（$1, $2, \1, \2）
- 大文字小文字変換（\u, \l, \U, \L）

**設計資料**: `docs/design/search_replace_spec.md`

**実装予定内容**:
- `app/src/search/regex.rs` - 正規表現エンジン統合
- `app/src/search/regex_matcher.rs` - 正規表現マッチャー
- `app/src/search/regex_replace.rs` - 正規表現置換
- `app/src/search/regex_patterns.rs` - 正規表現パターン管理

**依存関係**:
- `regex` クレート（既に依存関係に含まれている可能性あり）

---

### 2.2 TODO/FIXME コメントで示された未実装機能

以下は、ソースコード内のコメントから抽出された未実装機能:

#### 2.2.1 エラー処理の詳細実装
**ファイル**: `app/src/error.rs`  
**コメント**: `// TODO: プラットフォーム別に詳細実装（MVPでは0を返す）`

**内容**:
- 現在、エラーコードは常に0を返す
- プラットフォーム固有のエラーコード処理が未実装

**優先度**: 低（MVP後）

---

#### 2.2.2 ミニバッファの入力履歴
**ファイル**: `app/src/minibuffer/prompt.rs`  
**コメント**: `// TODO: 入力履歴の実装`

**内容**:
- コマンド入力履歴の保存・呼び出し機能が未実装
- M-p/M-n による履歴ナビゲーションが利用できない

**優先度**: 中

---

#### 2.2.3 カーソル位置計算の精度向上
**ファイル**: `app/src/buffer/cursor.rs`  
**複数のTODOコメント**:
- 実際の行長を取得して正確な列位置を設定
- 改行文字を検出して行・列を更新
- バッファから実際の文字位置を計算（複数箇所）

**内容**:
- カーソル位置計算の実装が簡略化されている
- タブ幅や文字幅を考慮した正確な位置計算が不完全

**優先度**: 中（ナビゲーション精度に影響）

---

#### 2.2.4 コマンド実装の未完成部分
**ファイル**: `app/src/input/commands.rs`  
**コメント**: `// TODO: ミニバッファでファイルパス入力を受け付ける実装が必要`

**内容**:
- 一部のファイル操作コマンドの実装が不完全
- ミニバッファとの連携が未実装の部分あり

**優先度**: 中

---

### 2.3 MVP 範囲外だが重要な未実装機能

#### 2.3.1 シンタックスハイライト
**状態**: 未実装  
**優先度**: 中〜高（将来フェーズ）

**内容**:
- Tree-sitter による構文解析とハイライト
- 言語ごとの色設定
- インクリメンタルな再解析

**参考**: README.md では将来実装として明記されている

---

#### 2.3.2 LSP 統合
**状態**: 未実装  
**優先度**: 高（将来フェーズ）

**内容**:
- Language Server Protocol クライアント実装
- コード補完、定義ジャンプ、リファレンス検索
- エラー・警告の表示

**参考**: README.md では将来実装として明記されている

---

#### 2.3.3 マウスサポート
**状態**: 未実装  
**優先度**: 低〜中

**内容**:
- マウスクリックによるカーソル移動
- マウスドラッグによる選択
- スクロールホイール対応

---

#### 2.3.4 複数エンコーディング対応
**状態**: 未実装（UTF-8 のみ）  
**優先度**: 中

**内容**:
- 現在は UTF-8 のみサポート
- Shift-JIS、EUC-JP などの対応
- 改行コードの自動判別（現在は LF のみ）

**参考**: AGENTS.md と docs/design/utf8_safety_spec.md

---

#### 2.3.5 設定ファイルのサポート
**状態**: 未実装  
**優先度**: 中

**内容**:
- `.altrerc` や設定ファイルの読み込み
- キーバインドのカスタマイズ
- テーマ・色設定のカスタマイズ

---

## 3. altre lisp の不足部分

### 3.1 言語機能の不足

#### 3.1.1 データ構造の未実装
**状態**: 未実装  
**優先度**: 高  
**参照**: `docs/adr-qa/alisp_QA.md` Q6

**不足しているデータ型**:
- **リスト**: Lisp の基本データ構造が未実装
  - `cons`, `car`, `cdr`, `list` などの操作
  - リストリテラル `'(1 2 3)`
- **ベクタ**: 配列的なデータ構造
  - `vector`, `vector-ref`, `vector-set!` などの操作
- **ハッシュテーブル**: 連想配列
  - `make-hash-table`, `hash-ref`, `hash-set!` などの操作

**優先順位**（QA文書より）:
1. リスト（最優先）
2. ハッシュテーブル
3. ベクタ

**実装方針**:
初期実装ではリストから段階的に追加していく。

---

#### 3.1.2 マクロシステムの未実装
**状態**: 未実装  
**優先度**: 中  
**参照**: `docs/adr-qa/alisp_QA.md` Q4

**不足している機能**:
- `defmacro` によるマクロ定義
- クォート・アンコート構文（`'`, `` ` ``, `,`, `,@`）
- マクロ展開機能
- `macroexpand` による展開確認

**備考**: MVP では実装せず、将来的に追加予定

---

#### 3.1.3 型システムの制限
**状態**: 一部実装済み  
**優先度**: 低〜中

**現在の実装**:
- 整数（i64）
- 浮動小数点数（f64）
- 真偽値
- 文字列
- 関数
- Unit 型

**不足している機能**:
- `nil` 値の実装（予約済みだが未実装）
- 任意精度整数
- 文字（character）型
- シンボル型の値としての扱い

---

### 3.2 標準ライブラリの不足

#### 3.2.1 文字列操作関数の不足
**状態**: 一部実装済み  
**優先度**: 中

**実装済み**:
- `string-append` - 文字列連結
- `string-length` - 文字列長取得

**不足している関数**:
- `substring` - 部分文字列取得
- `string-ref` - 文字アクセス
- `string-upcase`, `string-downcase` - 大文字小文字変換
- `string-trim` - 空白除去
- `string-split` - 文字列分割
- `string-replace` - 文字列置換
- `string-contains?` - 部分文字列検索
- `string->list`, `list->string` - リスト変換

---

#### 3.2.2 リスト操作関数の不足
**状態**: リスト自体が未実装
**優先度**: 高（リスト実装後）

**必要な関数**（将来実装時）:
- `cons`, `car`, `cdr` - 基本操作
- `list` - リスト生成
- `length` - 長さ取得
- `append` - リスト連結
- `reverse` - 逆順
- `map`, `filter`, `fold` - 高階関数
- `member`, `assoc` - 検索

---

#### 3.2.3 I/O 関数の不足
**状態**: ほぼ未実装  
**優先度**: 中

**実装済み**:
- `print` - ミニバッファへの出力のみ

**不足している関数**:
- `read` - 入力読み込み
- `read-line` - 1行読み込み
- `open-file`, `close-file` - ファイル操作
- `read-file`, `write-file` - ファイルI/O
- `format` - フォーマット出力

---

#### 3.2.4 数値関数の不足
**状態**: 一部実装済み  
**優先度**: 低

**実装済み**:
- 四則演算（`+`, `-`, `*`, `/`）
- 比較演算（`=`, `<`, `<=`, `>`, `>=`）
- `abs`, `floor`, `ceil`

**不足している関数**:
- `mod`, `quotient`, `remainder` - 剰余・商
- `sqrt` - 平方根
- `exp`, `log` - 指数・対数
- `sin`, `cos`, `tan` - 三角関数
- `round`, `truncate` - 丸め
- `min`, `max` - 最小・最大
- `random` - 乱数生成

---

### 3.3 エディタ統合機能の不足

#### 3.3.1 バッファ操作 API の未実装
**状態**: 未実装  
**優先度**: 高（alisp 統合フェーズ）

**必要な機能**:
- `current-buffer` - 現在のバッファ取得
- `buffer-string` - バッファ内容取得
- `insert` - テキスト挿入
- `delete-region` - テキスト削除
- `goto-char` - カーソル移動
- `point`, `point-min`, `point-max` - ポイント取得
- `buffer-size` - バッファサイズ
- `line-number-at-pos` - 行番号取得

---

#### 3.3.2 Interactive コマンドの未実装
**状態**: 未実装  
**優先度**: 高（alisp 統合フェーズ）  
**参照**: `docs/adr-qa/alisp_QA.md` Q1

**必要な機能**:
- `interactive` 特殊フォーム
- コマンド引数の仕様定義
- キーバインドへの登録
- M-x からの呼び出し

**備考**: MVP では実装せず、将来的に追加予定

---

#### 3.3.3 フック機能の未実装
**状態**: 未実装  
**優先度**: 中（将来フェーズ）

**必要な機能**:
- `add-hook`, `remove-hook` - フック管理
- 各種フックポイント（`before-save-hook`, `after-save-hook` など）
- フック関数の実行機構

---

#### 3.3.4 モードシステムの未実装
**状態**: 未実装  
**優先度**: 中（将来フェーズ）

**必要な機能**:
- メジャーモード・マイナーモードの概念
- モード定義機構
- モード切り替え
- モード固有のキーバインドと設定

---

### 3.4 GC とメモリ管理の課題

#### 3.4.1 GC の実装状態
**状態**: 実装済み（マーク＆スイープ方式）  
**優先度**: 低（監視・最適化）

**現在の実装**:
- `app/src/alisp/runtime/mod.rs` で GC を実装
- マーク＆スイープ方式
- 閾値ベースの自動実行

**潜在的な課題**:
- GC 実行時のパフォーマンス影響
- メモリ断片化
- 循環参照の扱い

**監視ポイント**:
- GC 実行頻度
- GC 実行時間
- メモリ使用量の推移

---

### 3.5 エラー処理とデバッグ支援

#### 3.5.1 エラーメッセージの改善余地
**状態**: 基本実装済み  
**優先度**: 中

**現在の実装**:
- `app/src/alisp/error.rs` でエラー型を定義
- 基本的なエラーメッセージ

**改善の余地**:
- スタックトレースの表示
- エラー位置の詳細表示（行番号、列番号）
- より詳細なエラー説明
- 修正提案の表示

---

#### 3.5.2 デバッグ機能の不足
**状態**: 未実装  
**優先度**: 低（将来フェーズ）

**必要な機能**:
- `trace` - 関数呼び出しトレース
- `debug` - デバッガ
- ブレークポイント
- ステップ実行
- 変数の inspect

---

### 3.6 パフォーマンス最適化の余地

#### 3.6.1 バイトコードコンパイラの未実装
**状態**: 未実装  
**優先度**: 低（将来フェーズ）  
**参照**: `docs/adr-qa/alisp_QA.md` Q2

**現在の実装**:
- AST を直接インタープリタで実行

**将来の最適化**:
- バイトコードへのコンパイル
- VM による実行
- JIT コンパイル（さらに将来）

---

## 4. テストカバレッジの不足

### 4.1 検索・置換のテスト不足
**状態**: 一部実装済み  
**タスクファイル**: `tasks/todo/mvp/24_search_replace_testing.md`

**不足しているテスト**:
- 置換機能の統合テスト
- 正規表現検索・置換のテスト
- エッジケース（空文字列、マルチバイト文字など）

---

### 4.2 alisp インタプリタのテスト不足
**状態**: 基本テストのみ

**不足しているテスト**:
- 再帰関数のテスト（現在失敗中）
- エラーケースの網羅的テスト
- パフォーマンステスト
- メモリリークテスト

---

## 5. 優先度付けと推奨実装順序

### 高優先度（MVP 完成のため早急に対応）
1. **alisp 再帰呼び出しの修正**（バグ修正）
2. **クエリ置換機能の実装**（M-%）
3. **リストデータ構造の実装**（alisp の基本機能）

### 中優先度（MVP 後の初期フェーズで対応）
4. **正規表現検索・置換の実装**
5. **Kill Ring と OS クリップボードの連動**
6. **ミニバッファの入力履歴実装**
7. **カーソル位置計算の精度向上**
8. **alisp のバッファ操作 API 実装**

### 低優先度（将来フェーズで対応）
9. シンタックスハイライト
10. LSP 統合
11. マクロシステム
12. Interactive コマンド機能
13. バイトコードコンパイラ

---

## 6. 次のアクションアイテム

### 即座に着手可能なタスク
1. **再帰呼び出し修正タスクの実施**
   - タスク: `tasks/todo/bugs/2510-recrusive-reference.md`
   - 所要時間: 2-3時間
   - 影響: alisp の基本機能として重要

2. **置換機能の実装開始**
   - タスク: `tasks/todo/mvp/22_replace_functionality_implementation.md`
   - 設計: 完了済み（`docs/design/search_replace_spec.md`）
   - 所要時間: 1-2日

### 設計・計画が必要なタスク
1. **リストデータ構造の設計**
   - 新規設計文書の作成が必要
   - GC との統合を考慮

2. **クリップボード統合の設計**
   - Emacs の挙動を参考に仕様を整理
   - プラットフォーム依存部分の抽象化

---

## 7. まとめ

### 現在の实装状況
- **MVP コア機能**: ほぼ完成（バッファ、ナビゲーション、基本編集、ファイル操作、検索）
- **alisp インタプリタ**: 基本機能は実装済みだが、再帰呼び出しのバグあり
- **不足機能**: 置換、正規表現、リストデータ構造、クリップボード統合など

### 品質面の課題
- 一部のTODOコメントが残存
- テストカバレッジに改善の余地
- エラーメッセージの改善余地

### 次のマイルストーン
1. MVP の完全完成（再帰修正 + 置換機能）
2. alisp の実用化（リスト実装 + バッファAPI）
3. エディタ機能の拡充（正規表現、LSP準備）

---

## 参考資料
- `README.md` - プロジェクト概要と現在の実装状況
- `AGENTS.md` - 開発ガイドライン
- `docs/adr-qa/alisp_QA.md` - alisp の設計判断
- `docs/design/search_replace_spec.md` - 検索・置換仕様
- `docs/design/alisp_language_spec.md` - alisp 言語仕様
- 既存タスクファイル: `tasks/todo/bugs/` および `tasks/todo/mvp/`
